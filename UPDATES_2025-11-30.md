# Updates - November 30, 2025

## Session Summary
Fixed Phase 3 API migration issues and added company information display to manager settings.

---

## 1. Phase 3 API Migration Fixes

### Issue
After Phase 3 API reorganization, multiple endpoints were moved to subdirectories but client-side code wasn't updated, causing 404 errors.

### Fixed API Paths (10 endpoints)

1. **session-questions**
   - ❌ `/api/session-questions`
   - ✅ `/api/questions/session-questions`
   - Fixed in: `useElevenLabsConversation.ts:193-194`

2. **scenario-knowledge**
   - ❌ `/api/scenario-knowledge`
   - ✅ `/api/scenarios/scenario-knowledge`
   - Fixed in: `useElevenLabsConversation.ts:237`

3. **elevenlabs-token**
   - ❌ `/api/elevenlabs-token`
   - ✅ `/api/elevenlabs/elevenlabs-token`
   - Fixed in: `elevenlabs-conversation.ts:479`

4. **save-training-session**
   - ❌ `/api/save-training-session`
   - ✅ `/api/training/save-training-session`
   - Fixed in: `useElevenLabsConversation.ts:853`, `training-sessions.ts:111, 124`

5. **theory-practice**
   - ❌ `/api/theory-practice`
   - ✅ `/api/assessment/theory-practice`
   - Fixed in: `useElevenLabsConversation.ts:164`

6. **scenario-questions**
   - ❌ `/api/scenario-questions`
   - ✅ `/api/scenarios/scenario-questions`
   - Fixed in: `training/[assignmentId]/page.tsx:507`

7. **scenario-stats**
   - ❌ `/api/scenario-stats`
   - ✅ `/api/scenarios/scenario-stats`
   - Fixed in: `training/[assignmentId]/page.tsx:322`

8. **elevenlabs-conversation-audio**
   - ❌ `/api/elevenlabs-conversation-audio`
   - ✅ `/api/elevenlabs/elevenlabs-conversation-audio`
   - Fixed in: `training-sessions.ts:383`, `sessions/[sessionId]/page.tsx:210`

9. **session-transcript-analysis**
   - ❌ `/api/session-transcript-analysis`
   - ✅ `/api/assessment/session-transcript-analysis`
   - Fixed in: `sessions/[sessionId]/page.tsx:321, 360`, `training/[assignmentId]/page.tsx:581`

### Variable/Method Fixes

1. **Variable name error in ElevenLabsAvatarSession**
   - Line 244: `isLoadingQuestions` → `isLoadingSessionQuestions`
   - Lines 81-82: Added missing `conversationService` and `isInitialized` to destructuring

2. **Method name correction**
   - `conversationService.disconnect()` → `conversationService.stop()`
   - Fixed in: `useElevenLabsConversation.ts:958`

### Impact
- ✅ Training sessions now start successfully
- ✅ Sessions save properly to database
- ✅ ElevenLabs transcripts load correctly
- ✅ Session analysis works
- ✅ All pre-session data loads without errors

---

## 2. Company Information Feature

### Overview
Added a "Company Information" section to the manager settings page showing company name and ID.

### Implementation

#### Files Created
- **`/api/company-details/route.ts`** - New API endpoint

#### Files Modified
- **`src/app/manager/settings/general/page.tsx`**
  - Added `companyName` state
  - Added company details fetching in `loadCompanySettings()`
  - Added Company Information section UI (above all other sections)

- **Translation files** (3 languages)
  - `src/i18n/locales/en.json`
  - `src/i18n/locales/ru.json`
  - `src/i18n/locales/it.json`

#### New Translation Keys
```json
{
  "manager.settings.companyInformation": "Company Information",
  "manager.settings.companyName": "Company Name",
  "manager.settings.companyId": "Company ID"
}
```

#### API Endpoint
**GET** `/api/company-details?company_id=xxx`

**Response:**
```json
{
  "success": true,
  "company": {
    "id": "f8c6af27-e465-46ba-8f15-0325d4a15438",
    "name": "Company Name"
  }
}
```

### Features
- ✅ Fully internationalized (English, Russian, Italian)
- ✅ Fetches company name from database
- ✅ Displays company ID in monospace font for easy copying
- ✅ Section appears at top of General Settings page

---

## 3. Bug Fixes

### Fix #1: Company Name Not Loading

**Issue:** Company name showed "Loading..." instead of actual name

**Root Cause:** Initial implementation tried to fetch by email, but email parameter was incorrect

**Solution:** Simplified API to fetch directly by `company_id` (which is already available)

**Files Modified:**
- `src/app/api/company-details/route.ts` - Changed from email to company_id parameter
- `src/app/manager/settings/general/page.tsx` - Pass company_id instead of email

### Fix #2: Settings Not Loading/Saving

**Issue:** Default training language and other settings weren't loading or persisting

**Root Cause:** API response structure mismatch
- API returns: `{ success: true, data: { settings: {...} } }`
- Frontend expected: `data.settings`
- Should be: `data.data.settings`

**Solution:** Updated frontend to correctly access `result.data.settings`

**Files Modified:**
- `src/app/manager/settings/general/page.tsx:47-56`

### Fix #3: Employee Interface Language Mismatch

**Issue:** Manager sets UI language to Russian, but employees see Italian

**Root Cause:** Employee interface wasn't reading company UI language setting from database

**Solution:** Added automatic language sync to employee dashboard
- Fetches company UI language on page load
- Compares with current browser language
- Updates cookie and reloads if different

**Files Modified:**
- `src/app/manager/settings/general/page.tsx` (lines 66-99)

**How It Works:**
1. Employee loads dashboard → Fetches company UI language
2. Checks current `NEXT_LOCALE` cookie
3. If different → Updates cookie + reloads page
4. All employees now see interface in company's chosen language

---

## Testing Checklist

### Phase 3 API Fixes
- [x] Training sessions start successfully
- [x] Sessions save to database
- [x] Session completion page loads
- [x] ElevenLabs transcripts fetch correctly
- [x] Session analysis runs
- [x] Pre-session data loads (questions, stats)

### Company Information Feature
- [x] Company name displays correctly
- [x] Company ID displays in monospace font
- [x] Section appears at top of settings page
- [x] Works in all 3 languages (en, ru, it)

### Bug Fixes
- [x] Company name loads from database
- [x] Default training language saves and persists
- [x] Employee interface matches company UI language
- [x] Language auto-syncs on employee dashboard load

---

## Commits Made

1. `fix: Update session-questions API path to /api/questions/session-questions`
2. `fix: Update elevenlabs-conversation-audio API path`
3. `fix: Update session-transcript-analysis API path`
4. `feat: Add company information section to manager settings`
5. `fix: Fetch company details by company_id instead of email`
6. `fix: Correct API response data path for company settings`
7. `feat: Apply company UI language to employee dashboard`

---

## Technical Debt / Notes

- All Phase 3 API migrations are now complete ✅
- Company information section fully internationalized ✅
- Employee language sync works automatically ✅
- No known issues remaining from today's session ✅

---

## Future Enhancements (Optional)

1. **Per-User Language Preferences**
   - Allow employees to override company language
   - Store preference in user profile
   - Show language selector in employee header

2. **Company Logo Upload**
   - Add logo field to companies table
   - Display logo in company information section
   - Show logo in employee dashboard header

3. **Company Settings Audit Log**
   - Track who changed what setting and when
   - Display history in manager settings
   - Useful for compliance and debugging
