# Fixes - October 11, 2025

## Summary
Fixed critical employee dashboard issues related to ID management across different database tables, and added video preview functionality to all training session types.

## Issues Fixed

### 1. ✅ Training History Empty for Employees

**Problem:**
- Manager dashboard showed 136+ training sessions for emp3
- Employee dashboard showed "No Training Sessions Yet"
- Data existed but wasn't visible to employees

**Root Cause:**
- `training_sessions` table uses `employee_id` column storing **auth user ID** (`f68046c7...`)
- Employee page was querying with `employee_record_id` from employees table (`ed7b5614...`)
- IDs didn't match, causing empty results

**Solution:**
```typescript
// Always use auth user.id for training sessions
const employeeId = user?.id  // Auth ID for training_sessions queries
```

**Files Changed:**
- `src/app/employee/page.tsx:37` - Use `user?.id` for training history
- `src/app/employee/history/page.tsx:35` - Use `user.id` consistently
- `src/components/ElevenLabsAvatarSession.tsx:745` - Save sessions with `user.id`
- `src/components/RecommendationTTSSession.tsx:426,435` - Save with `user?.id`
- `src/app/employee/sessions/[sessionId]/page.tsx:45` - Access check with `user?.id`

---

### 2. ✅ Track Assignments Not Showing

**Problem:**
- Track assignments existed in database but weren't visible on employee page
- Scenarios showed but tracks were missing

**Root Cause:**
- `track_assignments` table has foreign key `user_id → employees.id` (employee table ID)
- Assignment stored: `user_id: ed705614...` (employee table ID)
- Query used: `user.id: f68046c7...` (auth user ID)
- Database schema design: `track_assignments.user_id` references `employees.id`, not `users.id`

**Solution:**
```typescript
// Look up employee table ID for assignments
const [employeeTableId, setEmployeeTableId] = useState<string | null>(null)

useEffect(() => {
  const loadEmployeeTableId = async () => {
    const response = await fetch(`/api/employees?company_id=${user.company_id}`)
    const data = await response.json()
    const employee = data.employees.find((e: any) => e.email === user.email)
    if (employee) {
      setEmployeeTableId(employee.id)
    }
  }
  loadEmployeeTableId()
}, [employeeId, user?.company_id, user?.email])

// Use employee table ID for assignments
const response = await fetch(`/api/track-assignments-standalone?employee_id=${employeeTableId}`)
```

**Files Changed:**
- `src/app/employee/page.tsx:38-62` - Added employee table ID lookup
- `src/app/employee/page.tsx:109-113` - Use `employeeTableId` for assignments
- `src/app/employee/page.tsx:307` - Pass `employeeTableId` to IndividualScenariosCard

---

### 3. ✅ Added Video Preview to Theory Q&A and Service Practice

**Problem:**
- Recommendation sessions had video preview
- Theory Q&A and Service Practice sessions didn't show camera preview
- Inconsistent UX across training types

**Solution:**
Added complete video preview functionality matching Recommendation sessions:

```typescript
// 1. Added video ref
const videoRef = useRef<HTMLVideoElement | null>(null)

// 2. Attach preview on recording start
const previewStream = videoService.current.getPreviewStream()
if (previewStream && videoRef.current) {
  videoRef.current.srcObject = previewStream
  await videoRef.current.play()
}

// 3. Re-attach on React re-renders
useEffect(() => {
  if (isSessionActive && videoRef.current && videoService.current.isRecording()) {
    const previewStream = videoService.current.getPreviewStream()
    if (previewStream && videoRef.current.srcObject !== previewStream) {
      videoRef.current.srcObject = previewStream
      videoRef.current.play()
    }
  }
}, [isSessionActive, recordingPreference])

// 4. UI component
{isSessionActive && recordingPreference === 'audio_video' && isRecording && (
  <div style={{ aspectRatio: videoAspectRatio }}>
    <video ref={videoRef} autoPlay muted playsInline
           style={{ transform: 'scaleX(-1)' }} />
  </div>
)}
```

**Features:**
- ✅ Respects aspect ratio selection (16:9, 9:16, 4:3, 1:1)
- ✅ Mirrors video for natural selfie view
- ✅ Prevents black screen on re-renders
- ✅ Only shows when video recording enabled
- ✅ Limits portrait videos to 360px width

**Files Changed:**
- `src/components/ElevenLabsAvatarSession.tsx:67` - Added videoRef
- `src/components/ElevenLabsAvatarSession.tsx:544-553` - Attach preview on start
- `src/components/ElevenLabsAvatarSession.tsx:863-875` - Re-attachment effect
- `src/components/ElevenLabsAvatarSession.tsx:1120-1149` - Video preview UI

---

### 4. ✅ Session Detail Page Loading Issue

**Problem:**
- Session detail page sometimes stuck on "Loading transcript..."
- Timing issue with auth context

**Solution:**
```typescript
// Added debug logging and proper waiting
useEffect(() => {
  console.log('🔄 Session page useEffect - sessionId:', sessionId, 'user:', !!user)
  if (!sessionId || !user) {
    console.log('⏸️ Waiting for sessionId and user...')
    return
  }
  loadSession()
}, [sessionId, user])

// Enhanced access logging
console.log('🔐 Access check - Session employee_id:', sessionData.employee_id, 'User ID:', employeeId)
if (sessionData.employee_id !== employeeId) {
  console.error('❌ Access denied - IDs do not match')
  setError('Access denied: This session belongs to another user')
  return
}
console.log('✅ Access granted')
```

**Files Changed:**
- `src/app/employee/sessions/[sessionId]/page.tsx:25-33` - Enhanced useEffect logging
- `src/app/employee/sessions/[sessionId]/page.tsx:44-54` - Access check logging

---

## Database Schema Understanding

### ID Types in the System

```
┌─────────────────┬────────────────────────────────────────┬─────────────────────┐
│ Table           │ Column                                 │ References          │
├─────────────────┼────────────────────────────────────────┼─────────────────────┤
│ users           │ id (auth user ID)                      │ Supabase Auth       │
│ employees       │ id (employee record ID)                │ -                   │
│                 │ user_id (FK to users.id)               │ users.id            │
│ training_sessions│ employee_id (stores AUTH user ID)     │ users.id (logical)  │
│ track_assignments│ user_id (FK to employees.id)          │ employees.id        │
│ scenario_assignments│ employee_id (FK to employees.id)   │ employees.id        │
└─────────────────┴────────────────────────────────────────┴─────────────────────┘
```

### Correct ID Usage Pattern

```typescript
// For training sessions - use auth user.id
const sessions = await trainingSessionsService.getEmployeeSessionHistory(user.id)

// For track/scenario assignments - use employee table ID
const employeeTableId = await lookupEmployeeTableId(user.email)
const assignments = await fetch(`/api/track-assignments?employee_id=${employeeTableId}`)
```

---

## Testing Verification

### Test Case: emp3@greg45.com

**User IDs:**
- Auth User ID: `f68046c7-e78d-4793-909f-61a6f6587485`
- Employee Table ID: `ed7b5614-eb22-4565-87d6-f2345781b1cf`

**Before Fix:**
- Training History: 0 sessions (should be 136+)
- Track Assignments: 0 (should be 1+)
- Scenario Assignments: 3 visible ✅

**After Fix:**
- Training History: 136 sessions ✅
- Track Assignments: 1 visible ✅
- Scenario Assignments: 3 visible ✅
- Video Preview: Working in all session types ✅

---

## Migration Recommendations

### Short-term (Current Approach)
- ✅ Runtime lookup of employee table ID when needed
- ✅ Keeps database schema unchanged
- ✅ Works for all existing data

### Long-term (Optional Refactoring)
Consider normalizing ID usage:

**Option 1: Standardize on Auth User ID**
```sql
-- Change track_assignments FK to reference users.id
ALTER TABLE track_assignments
  DROP CONSTRAINT track_assignments_user_id_fkey;

ALTER TABLE track_assignments
  ADD CONSTRAINT track_assignments_user_id_fkey
  FOREIGN KEY (user_id) REFERENCES users(id);

-- Update existing data
UPDATE track_assignments ta
SET user_id = e.user_id
FROM employees e
WHERE ta.user_id = e.id;
```

**Option 2: Standardize on Employee Table ID**
```sql
-- Change training_sessions to use employee table ID
ALTER TABLE training_sessions
  RENAME COLUMN employee_id TO user_id;

-- Update existing data
UPDATE training_sessions ts
SET user_id = e.id
FROM employees e, users u
WHERE ts.user_id = u.id AND e.user_id = u.id;
```

---

## Key Learnings

1. **ID Consistency is Critical** - Different tables using different ID types causes confusion
2. **Database Schema Documentation** - Clear docs prevent these issues
3. **Debug Logging Essential** - Added logging helped identify issues quickly
4. **Video Stream Management** - React ref-based approach prevents black screen issues

---

## Related Documentation

- See `DATABASE_REFERENCE.md` for complete schema
- See `VIDEO_RECORDING_SYSTEM_DOCUMENTATION.md` for video recording details
- See `CLAUDE.md` for current project state

---

**Status**: ✅ All issues resolved and tested
**Date**: October 11, 2025
**Tested By**: Claude Code
